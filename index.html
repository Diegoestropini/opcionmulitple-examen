<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juego de Adivinanza Multiple Choice</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --accent: #10b981;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(16,185,129,0.08), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(52,211,153,0.08), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 32px 16px 64px;
    }
    .container {
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 20px;
    }
    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      padding: 20px;
    }
    h1 { margin: 0 0 12px; font-size: 26px; }
    h2 { margin: 0 0 10px; font-size: 20px; color: var(--muted); }
    label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 14px; }
    input, select, button, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.8);
      color: var(--text);
      font-size: 15px;
    }
    input:focus, textarea:focus, select:focus { outline: 2px solid var(--accent); }
    .field { margin-bottom: 12px; }
    button {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #0b1224;
      font-weight: 700;
      letter-spacing: 0.2px;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    #startBtn {
      background: linear-gradient(135deg, #facc15, #f97316);
      color: #0b1224;
      box-shadow: 0 10px 25px rgba(249,115,22,0.28);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    #startBtn:hover {
      box-shadow: 0 12px 32px rgba(250,204,21,0.35);
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(14,165,233,0.25); }
    button:active { transform: translateY(0); }
    .ghost-btn { background: rgba(148,163,184,0.1); color: var(--text); }
    .danger-btn { background: linear-gradient(135deg, #f43f5e, #fb7185); color: #fff; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .chip {
      background: rgba(148,163,184,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    .questions-list { max-height: 360px; overflow: auto; display: grid; gap: 10px; }
    .item {
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(15,23,42,0.6);
    }
    .item strong { display: block; margin-bottom: 4px; }
    .options { display: grid; gap: 4px; color: var(--muted); font-size: 14px; }
    .badge { padding: 2px 8px; background: rgba(16,185,129,0.14); color: #34d399; border-radius: 999px; font-size: 12px; margin-left: 6px; }
    .game-area { display: grid; gap: 16px; }
    .question-box { border: 1px solid rgba(148,163,184,0.2); border-radius: 14px; padding: 16px; background: rgba(15,23,42,0.7); transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    .question-box .question-text { font-size: 18px; margin-bottom: 12px; transition: color 0.3s ease, text-shadow 0.3s ease; }
    .question-box .option-btn { width: 100%; text-align: left; margin-bottom: 10px; background: rgba(148,163,184,0.08); color: var(--text); transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease; }
    .question-box.is-active { border-color: rgba(129,140,248,0.4); box-shadow: 0 12px 35px rgba(99,102,241,0.25); }
    .question-box.is-active .question-text { color: #fef08a; text-shadow: 0 2px 12px rgba(248,250,252,0.15); }
    .question-box.is-active .option-btn { background: linear-gradient(135deg, rgba(14,165,233,0.18), rgba(236,72,153,0.18)); border: 1px solid rgba(14,165,233,0.4); color: #e0f2fe; box-shadow: 0 10px 30px rgba(99,102,241,0.15); }
    .question-box.is-active .option-btn:hover { background: linear-gradient(135deg, rgba(14,165,233,0.28), rgba(236,72,153,0.28)); border-color: rgba(236,72,153,0.55); color: #fff; box-shadow: 0 14px 38px rgba(236,72,153,0.2); }
    .status { display: flex; align-items: center; gap: 8px; color: var(--muted); }
    .status .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(148,163,184,0.12); border: 1px solid rgba(148,163,184,0.2); font-size: 13px; }
    .row { display: flex; gap: 10px; align-items: center; }
    .row-fill > * { flex: 1; }
    .materia-row { display: grid; grid-template-columns: 1fr 180px; gap: 10px; }
    .item-actions { display: flex; gap: 8px; margin-top: 8px; }
    .mini-btn { width: auto; padding: 6px 10px; font-size: 13px; }
    .mini-btn.danger-btn { background: linear-gradient(135deg, #ef4444, #f97316); }
    .option-btn.correct { background: rgba(16,185,129,0.18); color: #bbf7d0; border: 1px solid rgba(16,185,129,0.6); }
    .option-btn.incorrect { background: rgba(239,68,68,0.18); color: #fecdd3; border: 1px solid rgba(239,68,68,0.5); }
    .stats { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; align-items: center; }
    .pill.success { background: rgba(16,185,129,0.16); color: #bbf7d0; border-color: rgba(16,185,129,0.4); }
    .pill.danger { background: rgba(239,68,68,0.16); color: #fecdd3; border-color: rgba(239,68,68,0.4); }
    .pill.info { background: rgba(14,165,233,0.16); color: #bae6fd; border-color: rgba(14,165,233,0.4); }
    .errores-panel { border: 1px solid rgba(148,163,184,0.2); border-radius: 14px; padding: 14px; background: rgba(15,23,42,0.7); display: grid; gap: 8px; }
    .errores-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
    .errores-title { margin: 0; font-size: 16px; color: var(--muted); }
    .errores-list { display: grid; gap: 8px; }
    .error-item { display: flex; justify-content: space-between; align-items: center; gap: 12px; background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); border-radius: 10px; padding: 10px 12px; }
    .error-text { margin: 0; font-size: 14px; color: #fecdd3; }
    .error-count { background: rgba(239,68,68,0.2); color: #fecdd3; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(248,113,113,0.35); font-weight: 700; }
  </style>
</head>
<body>
  <div class="container">
    <section class="card">
      <h1>Crear preguntas</h1>
      <div class="field">
        <label for="materiaSelect">Materia</label>
        <div class="materia-row">
          <select id="materiaSelect"></select>
          <button id="addMateriaBtn" type="button" class="ghost-btn">Agregar otra materia</button>
        </div>
      </div>
      <div class="field" id="nuevaMateriaField" style="display:none;">
        <label for="materiaNombre">Nueva materia</label>
        <div class="row row-fill">
          <input id="materiaNombre" type="text" placeholder="Ej: Historia" />
          <button id="guardarMateriaBtn" type="button">Guardar materia</button>
        </div>
      </div>
      <div class="two-col">
        <div class="field">
          <label for="pregunta">Pregunta</label>
          <input id="pregunta" type="text" placeholder="Escribe la pregunta" />
        </div>
        <div class="field">
          <label for="opcionesCount">Cantidad de opciones</label>
          <input id="opcionesCount" type="number" min="2" max="6" value="4" />
        </div>
      </div>
      <div id="opcionesContainer" class="field"></div>
      <div class="two-col">
        <button id="addQuestionBtn">Agregar pregunta</button>
        <button id="clearBtn" class="danger-btn" type="button">Eliminar materia</button>
      </div>
      <p id="formMessage" class="chip" style="display:none;"></p>
      <h2>Preguntas guardadas</h2>
      <div class="chips" id="materiaInfo"></div>
      <div class="questions-list" id="listaPreguntas"></div>
    </section>

    <section class="card">
      <h1>Jugar</h1>
      <div class="game-area">
        <div class="row" style="justify-content: space-between;">
          <div class="status"><span class="dot"></span><span id="estadoJuego">Esperando…</span></div>
          <div class="row stats">
            <div class="pill success" id="correctas">✅ 0</div>
            <div class="pill danger" id="incorrectas">❌ 0</div>
            <div class="pill info" id="efectividad">Efectividad: 0%</div>
            <div class="pill" id="contador">0/0</div>
            <button id="startBtn" class="ghost-btn" type="button">Empezar juego</button>
          </div>
        </div>
        <div class="question-box" id="questionBox">
          <div class="question-text" id="textoPregunta">Agrega preguntas y presiona "Empezar juego"</div>
          <div id="opcionesJuego"></div>
        </div>
        <div class="errores-panel" id="erroresContainer">
          <div class="errores-header">
            <h3 class="errores-title">Preguntas respondidas incorrectamente</h3>
            <div class="pill danger errores-count" id="erroresContador">0 errores</div>
          </div>
          <div id="erroresLista" class="errores-list">
            <p class="chip">Aún no hay respuestas incorrectas.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const materiaSelect = document.getElementById('materiaSelect');
    const addMateriaBtn = document.getElementById('addMateriaBtn');
    const nuevaMateriaField = document.getElementById('nuevaMateriaField');
    const materiaNombreInput = document.getElementById('materiaNombre');
    const guardarMateriaBtn = document.getElementById('guardarMateriaBtn');
    const preguntaInput = document.getElementById('pregunta');
    const opcionesCountInput = document.getElementById('opcionesCount');
    const opcionesContainer = document.getElementById('opcionesContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const startBtn = document.getElementById('startBtn');
    const listaPreguntas = document.getElementById('listaPreguntas');
    const materiaInfo = document.getElementById('materiaInfo');
    const formMessage = document.getElementById('formMessage');
    const clearBtn = document.getElementById('clearBtn');
    const questionBox = document.getElementById('questionBox');

    const textoPregunta = document.getElementById('textoPregunta');
    const opcionesJuego = document.getElementById('opcionesJuego');
    const estadoJuego = document.getElementById('estadoJuego');
    const contador = document.getElementById('contador');
    const correctasEl = document.getElementById('correctas');
    const incorrectasEl = document.getElementById('incorrectas');
    const efectividadEl = document.getElementById('efectividad');
    const erroresContador = document.getElementById('erroresContador');
    const erroresContainer = document.getElementById('erroresContainer');
    const erroresLista = document.getElementById('erroresLista');

    let materias = [];
    let materiaActualId = '';
    let preguntas = [];
    let indiceActual = 0;
    let ordenPreguntas = [];
    let pendientes = [];
    let totalPreguntas = 0;
    let completadas = new Set();
    let preguntaEditando = null;
    let correctas = 0;
    let incorrectas = 0;
    let erroresPregunta = {};

    const STORAGE_KEY = 'quiz-multi-choice';

    function guardar() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ materias, materiaActualId }));
      renderLista();
    }

    function setPreguntaActiva(activa) {
      questionBox?.classList.toggle('is-active', Boolean(activa));
    }

    function cargar() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        if (Array.isArray(parsed.materias)) {
          materias = parsed.materias;
          materiaActualId = parsed.materiaActualId || parsed.materiaActual || '';
        } else {
          const legacyMateria = parsed.materia || '';
          materias = [{ id: `mat-${Date.now()}`, nombre: legacyMateria, preguntas: parsed.preguntas || [] }];
          materiaActualId = materias[0].id;
        }
      }
      renderMateriaSelect();
      seleccionarMateria(materiaActualId || materias[0]?.id || '');
      renderLista();
      renderMateriaInfo();
    }

    function renderMateriaSelect() {
      materiaSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = materias.length ? 'Selecciona una materia' : 'Crea una materia para empezar';
      materiaSelect.appendChild(placeholder);
      materias.forEach((m) => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = `${m.nombre || 'Sin nombre'} (${m.preguntas.length})`;
        materiaSelect.appendChild(opt);
      });
      if (materiaActualId) {
        materiaSelect.value = materiaActualId;
      }
    }

    function renderMateriaInfo() {
      materiaInfo.innerHTML = '';
      const materia = obtenerMateriaActual();
      if (!materia || !materia.nombre) return;
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = `Materia: ${materia.nombre} (${materia.preguntas.length} preguntas)`;
      materiaInfo.appendChild(chip);
    }

    function renderLista() {
      renderMateriaInfo();
      listaPreguntas.innerHTML = '';
      if (!preguntas.length) {
        listaPreguntas.innerHTML = '<p class="chip">No hay preguntas guardadas.</p>';
        return;
      }
      preguntas.forEach((p, idx) => {
        const card = document.createElement('div');
        card.className = 'item';
        const opciones = p.opciones.map((o, i) => {
          const correcta = i === p.correcta ? '<span class="badge">Correcta</span>' : '';
          return `<span>${i + 1}. ${o} ${correcta}</span>`;
        }).join('');
        card.innerHTML = `<strong>${idx + 1}. ${p.texto}</strong><div class="options">${opciones}</div>`;
        const acciones = document.createElement('div');
        acciones.className = 'item-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'mini-btn ghost-btn';
        editBtn.textContent = 'Editar';
        editBtn.onclick = () => editarPregunta(idx);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'mini-btn danger-btn';
        deleteBtn.textContent = 'Borrar';
        deleteBtn.onclick = () => eliminarPregunta(idx);
        acciones.appendChild(editBtn);
        acciones.appendChild(deleteBtn);
        card.appendChild(acciones);
        listaPreguntas.appendChild(card);
      });
    }

    function mostrarMensaje(texto, tipo = 'ok') {
      formMessage.style.display = 'block';
      formMessage.textContent = texto;
      formMessage.style.color = tipo === 'ok' ? '#34d399' : '#f87171';
      setTimeout(() => { formMessage.style.display = 'none'; }, 2200);
    }

    function obtenerMateriaActual() {
      return materias.find((m) => m.id === materiaActualId);
    }

    function seleccionarMateria(id) {
      materiaActualId = id;
      const materia = obtenerMateriaActual();
      preguntas = materia ? materia.preguntas : [];
      totalPreguntas = preguntas.length;
      completadas = new Set();
      pendientes = [];
      ordenPreguntas = [];
      indiceActual = 0;
      preguntaEditando = null;
      addQuestionBtn.textContent = 'Agregar pregunta';
      preguntaInput.value = '';
      construirCamposOpciones();
      contador.textContent = `${completadas.size}/${totalPreguntas || 0}`;
      actualizarStats();
      estadoJuego.textContent = 'Esperando…';
      textoPregunta.textContent = materia ? 'Agrega preguntas y presiona "Empezar juego"' : 'Crea o selecciona una materia para empezar.';
      opcionesJuego.innerHTML = '';
      setPreguntaActiva(false);
      renderMateriaSelect();
      renderLista();
      renderMateriaInfo();
      guardar();
      reiniciarErrores();
    }

    function toggleNuevaMateria() {
      const visible = nuevaMateriaField.style.display !== 'none';
      nuevaMateriaField.style.display = visible ? 'none' : 'block';
      if (!visible) {
        materiaNombreInput.focus();
      }
    }

    function crearNuevaMateria() {
      const nombre = materiaNombreInput.value.trim();
      if (!nombre) return mostrarMensaje('Ingresa el nombre de la materia', 'error');
      if (materias.some((m) => m.nombre.toLowerCase() === nombre.toLowerCase())) {
        return mostrarMensaje('Esa materia ya existe', 'error');
      }
      const id = `mat-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      const nueva = { id, nombre, preguntas: [] };
      materias.push(nueva);
      materiaNombreInput.value = '';
      nuevaMateriaField.style.display = 'none';
      materiaActualId = id;
      preguntas = nueva.preguntas;
      totalPreguntas = 0;
      completadas = new Set();
      pendientes = [];
      ordenPreguntas = [];
      indiceActual = 0;
      preguntaEditando = null;
      correctas = 0;
      incorrectas = 0;
      addQuestionBtn.textContent = 'Agregar pregunta';
      preguntaInput.value = '';
      construirCamposOpciones();
      renderMateriaSelect();
      materiaSelect.value = id;
      renderLista();
      renderMateriaInfo();
      textoPregunta.textContent = 'Agrega preguntas y presiona "Empezar juego"';
      estadoJuego.textContent = 'Esperando…';
      contador.textContent = '0/0';
      actualizarStats();
      reiniciarErrores();
      guardar();
      mostrarMensaje('Materia agregada');
    }

    function construirCamposOpciones(valores = [], correctaMarcada = 0) {
      const count = valores.length || Math.min(Math.max(parseInt(opcionesCountInput.value, 10) || 0, 2), 6);
      opcionesContainer.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const wrap = document.createElement('div');
        wrap.className = 'field';
        const valor = valores[i] || '';
        const checked = i === correctaMarcada ? 'checked' : '';
        wrap.innerHTML = `
          <label>Opción ${i + 1} ${i === 0 ? '(correcta por defecto)' : ''}</label>
          <div class="two-col">
            <input type="text" data-opcion="${i}" placeholder="Texto de la opción" value="${valor}" />
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
              <input type="radio" name="correcta" value="${i}" ${checked || (i === 0 && !valores.length ? 'checked' : '')} />
              Correcta
            </label>
          </div>`;
        opcionesContainer.appendChild(wrap);
      }
    }

    function obtenerOpciones() {
      const inputs = opcionesContainer.querySelectorAll('input[type="text"]');
      const opciones = [];
      inputs.forEach((inp) => opciones.push(inp.value.trim()));
      const correcta = parseInt(opcionesContainer.querySelector('input[type="radio"]:checked')?.value || '0', 10);
      return { opciones, correcta };
    }

    function validarPregunta() {
      const materia = obtenerMateriaActual();
      const texto = preguntaInput.value.trim();
      const { opciones, correcta } = obtenerOpciones();

      if (!materia || !materia.nombre) return mostrarMensaje('Selecciona o crea una materia', 'error');
      if (!texto) return mostrarMensaje('Ingresa la pregunta', 'error');
      if (opciones.some(o => !o)) return mostrarMensaje('Completa todas las opciones', 'error');

      if (preguntaEditando !== null) {
        preguntas[preguntaEditando] = { texto, opciones, correcta };
        preguntaEditando = null;
        addQuestionBtn.textContent = 'Agregar pregunta';
        mostrarMensaje('Pregunta actualizada');
      } else {
        preguntas.push({ texto, opciones, correcta });
        mostrarMensaje('Pregunta agregada');
      }
      guardar();
      renderMateriaInfo();
      renderLista();
      preguntaInput.value = '';
      opcionesContainer.querySelectorAll('input[type="text"]').forEach(inp => inp.value = '');
    }

    function barajar(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function iniciarJuego() {
      if (!materiaActualId) {
        estadoJuego.textContent = 'Selecciona una materia';
        return;
      }
      if (!preguntas.length) {
        estadoJuego.textContent = 'Agrega preguntas primero';
        return;
      }
      ordenPreguntas = barajar(preguntas.map((_, i) => i));
      pendientes = [];
      indiceActual = 0;
      totalPreguntas = preguntas.length;
      completadas = new Set();
      contador.textContent = `${completadas.size}/${totalPreguntas}`;
      correctas = 0;
      incorrectas = 0;
      reiniciarErrores();
      actualizarStats();
      estadoJuego.textContent = 'En progreso';
      setPreguntaActiva(true);
      mostrarPreguntaActual();
    }

    function mostrarPreguntaActual() {
      if (!ordenPreguntas.length) {
        textoPregunta.textContent = 'Agrega preguntas y presiona "Empezar juego"';
        opcionesJuego.innerHTML = '';
        contador.textContent = `${completadas.size}/${totalPreguntas || preguntas.length || 0}`;
        setPreguntaActiva(false);
        return;
      }
      if (indiceActual >= ordenPreguntas.length) {
        if (pendientes.length) {
          ordenPreguntas = pendientes;
          pendientes = [];
          indiceActual = 0;
        } else {
          estadoJuego.textContent = 'Completado ✅';
          textoPregunta.textContent = '¡Terminaste todas las preguntas!';
          opcionesJuego.innerHTML = '';
          contador.textContent = `${completadas.size}/${totalPreguntas}`;
          actualizarStats();
          setPreguntaActiva(false);
          return;
        }
      }

      const pregunta = preguntas[ordenPreguntas[indiceActual]];
      setPreguntaActiva(true);
      textoPregunta.textContent = pregunta.texto;
      contador.textContent = `${completadas.size}/${totalPreguntas}`;
      opcionesJuego.innerHTML = '';
      const ordenOpciones = barajar(pregunta.opciones.map((_, i) => i));
      ordenOpciones.forEach((optIndex) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = pregunta.opciones[optIndex];
        btn.dataset.esCorrecta = optIndex === pregunta.correcta ? 'true' : 'false';
        btn.onclick = () => validarRespuesta(optIndex === pregunta.correcta, btn);
        opcionesJuego.appendChild(btn);
      });
    }

    function validarRespuesta(esCorrecta, btn) {
      const botones = Array.from(opcionesJuego.querySelectorAll('button'));
      botones.forEach((b) => { b.disabled = true; });
      const correctaBtn = botones.find((b) => b.dataset.esCorrecta === 'true');

      if (esCorrecta) {
        btn.classList.add('correct');
        estadoJuego.textContent = '¡Correcto!';
        completadas.add(ordenPreguntas[indiceActual]);
        correctas += 1;
      } else {
        btn.classList.add('incorrect');
        if (correctaBtn) correctaBtn.classList.add('correct');
        if (!pendientes.includes(ordenPreguntas[indiceActual])) {
          pendientes.push(ordenPreguntas[indiceActual]);
        }
        estadoJuego.textContent = 'Respuesta incorrecta';
        incorrectas += 1;
        registrarError(ordenPreguntas[indiceActual]);
      }

      contador.textContent = `${completadas.size}/${totalPreguntas}`;
      actualizarStats();
      setTimeout(() => {
        indiceActual += 1;
        mostrarPreguntaActual();
      }, 900);
    }

    function confirmarBorrado() {
      const materia = obtenerMateriaActual();
      if (!materia) return;
      const seguro = confirm(`¿Seguro que quieres borrar la materia "${materia.nombre || 'sin nombre'}"?`);
      if (!seguro) return;
      materias = materias.filter((m) => m.id !== materiaActualId);
      materiaActualId = materias[0]?.id || '';
      preguntas = obtenerMateriaActual()?.preguntas || [];
      totalPreguntas = preguntas.length;
      completadas = new Set();
      pendientes = [];
      ordenPreguntas = [];
      indiceActual = 0;
      preguntaEditando = null;
      addQuestionBtn.textContent = 'Agregar pregunta';
      renderMateriaSelect();
      renderLista();
      renderMateriaInfo();
      textoPregunta.textContent = materiaActualId ? 'Materia eliminada. Selecciona otra para jugar.' : 'Materia eliminada. Agrega nuevas preguntas para jugar.';
      opcionesJuego.innerHTML = '';
      estadoJuego.textContent = 'Esperando…';
      contador.textContent = '0/0';
      correctas = 0;
      incorrectas = 0;
      actualizarStats();
      reiniciarErrores();
      preguntaInput.value = '';
      construirCamposOpciones();
      guardar();
    }

    function editarPregunta(idx) {
      const pregunta = preguntas[idx];
      if (!pregunta) return;
      preguntaEditando = idx;
      preguntaInput.value = pregunta.texto;
      opcionesCountInput.value = pregunta.opciones.length;
      construirCamposOpciones(pregunta.opciones, pregunta.correcta);
      addQuestionBtn.textContent = 'Guardar cambios';
      mostrarMensaje('Editando pregunta seleccionada');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function eliminarPregunta(idx) {
      if (!confirm('¿Eliminar esta pregunta?')) return;
      preguntas.splice(idx, 1);
      totalPreguntas = preguntas.length;
      completadas = new Set();
      pendientes = [];
      ordenPreguntas = [];
      indiceActual = 0;
      preguntaEditando = null;
      addQuestionBtn.textContent = 'Agregar pregunta';
      estadoJuego.textContent = 'Esperando…';
      textoPregunta.textContent = 'Agrega preguntas y presiona "Empezar juego"';
      opcionesJuego.innerHTML = '';
      contador.textContent = `${completadas.size}/${totalPreguntas || 0}`;
      correctas = 0;
      incorrectas = 0;
      actualizarStats();
      reiniciarErrores();
      setPreguntaActiva(false);
      guardar();
      renderLista();
    }

    function actualizarStats() {
      const totalIntentos = correctas + incorrectas;
      const efectividad = totalIntentos ? Math.round((correctas / totalIntentos) * 100) : 0;
      correctasEl.textContent = `✅ ${correctas}`;
      incorrectasEl.textContent = `❌ ${incorrectas}`;
      efectividadEl.textContent = `Efectividad: ${efectividad}%`;
    }

    function reiniciarErrores() {
      erroresPregunta = {};
      renderErrores();
    }

    function registrarError(preguntaIdx) {
      const pregunta = preguntas[preguntaIdx];
      if (!pregunta) return;
      const registroActual = erroresPregunta[preguntaIdx] || { texto: pregunta.texto, conteo: 0 };
      erroresPregunta[preguntaIdx] = { ...registroActual, conteo: registroActual.conteo + 1 };
      renderErrores();
    }

    function renderErrores() {
      erroresLista.innerHTML = '';
      const entradas = Object.entries(erroresPregunta);
      if (!entradas.length) {
        erroresLista.innerHTML = '<p class="chip">Aún no hay respuestas incorrectas.</p>';
        erroresContador.textContent = '0 errores';
        return;
      }

      const totalErrores = entradas.reduce((acc, [, info]) => acc + info.conteo, 0);
      erroresContador.textContent = `${totalErrores} ${totalErrores === 1 ? 'error' : 'errores'}`;

      entradas
        .sort(([, a], [, b]) => b.conteo - a.conteo)
        .forEach(([, info]) => {
          const item = document.createElement('div');
          item.className = 'error-item';
          const texto = document.createElement('p');
          texto.className = 'error-text';
          texto.textContent = info.texto;
          const conteo = document.createElement('div');
          conteo.className = 'error-count';
          conteo.textContent = `${info.conteo}×`;
          item.appendChild(texto);
          item.appendChild(conteo);
          erroresLista.appendChild(item);
        });
    }

    opcionesCountInput.addEventListener('change', construirCamposOpciones);
    addQuestionBtn.addEventListener('click', validarPregunta);
    startBtn.addEventListener('click', iniciarJuego);
    clearBtn.addEventListener('click', confirmarBorrado);
    materiaSelect.addEventListener('change', (e) => seleccionarMateria(e.target.value));
    addMateriaBtn.addEventListener('click', toggleNuevaMateria);
    guardarMateriaBtn.addEventListener('click', crearNuevaMateria);
    materiaNombreInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') crearNuevaMateria(); });

    construirCamposOpciones();
    cargar();
  </script>
</body>
</html>
